services:
  db_test:
    build:
      context: ./mongodb
    hostname: db_test
    environment:
      - MONGODB_HOSTNAME=db_test
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=admin
      - ADMIN_DATABASE=admin
      - COMMON_DATABASE=ELANDB
      - COMMON_USERNAME=test
      - COMMON_PASSWORD=test
    healthcheck:
      test: ["CMD-SHELL", "mongosh -u $$COMMON_USERNAME -p $$COMMON_PASSWORD \"mongodb://$${MONGODB_HOSTNAME}\" || exit 1"]
      interval: 7s
      timeout: 2s
      retries: 3
  api_test:
    build:
      context: .
      args:
      - CONFIG_PATH=./configs/test.json
    depends_on:
      db_test:
        condition: service_healthy
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://api_test:4242/api/service/ping || exit 1
      interval: 10s
      timeout: 10m
      retries: 3
    tty: true
  test:
    build:
      context: ./tests
    depends_on:
      api_test:
        condition: service_healthy
    tty: true
